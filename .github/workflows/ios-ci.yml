name: iOS CI

on:
  pull_request:
  push:
    branches: ["main"]

concurrency:
  group: ios-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-lint-test:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Select latest Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode_*.app | sort -V | tail -n 1)
          echo "Using $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode version
        run: xcodebuild -version

      - name: Detect workspace/project + scheme
        id: xcode
        shell: bash
        env:
          PYTHON_GET_SCHEME: |
            import json, sys
            data = json.load(sys.stdin)
            root = (data.get("workspace") or data.get("project") or {})
            schemes = (root.get("schemes") or [])
            print(schemes[0] if schemes else "")
          PYTHON_GET_UDID: |
            import json, sys, re
            data = json.load(sys.stdin)
            devices = (data.get("devices", {}) or {})
            devs = []
            for v in devices.values():
                devs.extend(v or [])
            iph = [d for d in devs if d.get("isAvailable") and str(d.get("name", "")).startswith("iPhone") and d.get("udid")]
            pref = [d for d in iph if re.match(r"^iPhone\s+\d", str(d.get("name", "")))]
            use = pref or iph
            use.sort(key=lambda d: ("Pro Max" in d.get("name", ""), "Pro" in d.get("name", ""), d.get("name", "")))
            if use:
                print(use[-1]["udid"])
        run: |
          set -euo pipefail

          # Ignore Xcode's internal workspace inside an .xcodeproj (e.g. MyApp.xcodeproj/project.xcworkspace)
          WORKSPACE="$(find . -maxdepth 3 -name "*.xcworkspace" -not -path "*/.xcodeproj/*" -not -path "*.xcodeproj/*" -print -quit || true)"
          PROJECT="$(find . -maxdepth 3 -name "*.xcodeproj" -print -quit || true)"

          if [[ -n "${WORKSPACE}" ]]; then
            echo "container_type=workspace" >> "$GITHUB_OUTPUT"
            echo "container_path=${WORKSPACE}" >> "$GITHUB_OUTPUT"
            JSON="$(xcodebuild -list -json -workspace "${WORKSPACE}")"
          elif [[ -n "${PROJECT}" ]]; then
            echo "container_type=project" >> "$GITHUB_OUTPUT"
            echo "container_path=${PROJECT}" >> "$GITHUB_OUTPUT"
            JSON="$(xcodebuild -list -json -project "${PROJECT}")"
          else
            echo "ERROR: Could not find an .xcworkspace or .xcodeproj in the repo."
            echo "Create an Xcode iOS project and commit it, then re-run CI."
            exit 1
          fi

          # Pick the first listed scheme. (For real projects you may want to hardcode this.)
          SCHEME="$(printf '%s' "${JSON}" | python3 -c "${PYTHON_GET_SCHEME}")"

          if [[ -z "${SCHEME}" ]]; then
            echo "ERROR: No schemes found."
            echo "Make sure you have at least one scheme and it is Shared:"
            echo "Xcode -> Product -> Scheme -> Manage Schemes -> check 'Shared' -> commit the .xcscheme."
            exit 1
          fi

          echo "scheme=${SCHEME}" >> "$GITHUB_OUTPUT"

          # Pick an available iPhone simulator (avoid hardcoding a specific model)
          SIM_JSON="$(xcrun simctl list -j devices available)"
          UDID="$(printf '%s' "${SIM_JSON}" | python3 -c "${PYTHON_GET_UDID}")"

          if [[ -z "${UDID}" ]]; then
            echo "ERROR: Could not find an available iPhone simulator on this runner."
            xcrun simctl list devices available
            exit 1
          fi
          echo "destination=platform=iOS Simulator,id=${UDID}" >> "$GITHUB_OUTPUT"

      - name: Resolve Swift Package dependencies
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ steps.xcode.outputs.container_type }}" == "workspace" ]]; then
            xcodebuild -resolvePackageDependencies -workspace "${{ steps.xcode.outputs.container_path }}" -scheme "${{ steps.xcode.outputs.scheme }}"
          else
            xcodebuild -resolvePackageDependencies -project "${{ steps.xcode.outputs.container_path }}" -scheme "${{ steps.xcode.outputs.scheme }}"
          fi

      - name: SwiftLint (optional)
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -f ".swiftlint.yml" ]]; then
            echo "No .swiftlint.yml found; skipping SwiftLint."
            exit 0
          fi

          if ! command -v swiftlint >/dev/null 2>&1; then
            export HOMEBREW_NO_AUTO_UPDATE=1
            brew install swiftlint
          fi

          swiftlint version
          swiftlint lint --reporter github-actions-logging

      - name: Build (iOS Simulator, no signing)
        shell: bash
        run: |
          set -euo pipefail
          DESTINATION="${{ steps.xcode.outputs.destination }}"
          COMMON_ARGS=(
            -scheme "${{ steps.xcode.outputs.scheme }}"
            -destination "${DESTINATION}"
            CODE_SIGNING_ALLOWED=NO
            CODE_SIGNING_REQUIRED=NO
            CODE_SIGN_IDENTITY=""
          )

          if [[ "${{ steps.xcode.outputs.container_type }}" == "workspace" ]]; then
            xcodebuild build -workspace "${{ steps.xcode.outputs.container_path }}" "${COMMON_ARGS[@]}"
          else
            xcodebuild build -project "${{ steps.xcode.outputs.container_path }}" "${COMMON_ARGS[@]}"
          fi

      - name: Test (unit + UI on Simulator)
        shell: bash
        run: |
          set -euo pipefail
          DESTINATION="${{ steps.xcode.outputs.destination }}"
          COMMON_ARGS=(
            -scheme "${{ steps.xcode.outputs.scheme }}"
            -destination "${DESTINATION}"
            CODE_SIGNING_ALLOWED=NO
            CODE_SIGNING_REQUIRED=NO
            CODE_SIGN_IDENTITY=""
          )

          if [[ "${{ steps.xcode.outputs.container_type }}" == "workspace" ]]; then
            xcodebuild test -workspace "${{ steps.xcode.outputs.container_path }}" "${COMMON_ARGS[@]}"
          else
            xcodebuild test -project "${{ steps.xcode.outputs.container_path }}" "${COMMON_ARGS[@]}"
          fi

